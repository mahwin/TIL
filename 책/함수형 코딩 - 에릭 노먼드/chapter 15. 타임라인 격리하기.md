## 타임라인 다이어그램

타임라인은 액션을 순서대로 나열한 것이다. 타임라인 다이어그램은 시간에 따른 액션 순서를 시각적으로 표시한 것이다.

## 버그 상황을 해석하고 타임라인을 격리해보자

장바구니의 합계 결과가 예상과 다르게 나오고 있다. 아래 코드를 이해하자

```js
function add_item_to_cart(name, price, quantity) {
  cart = add_item(cart, name, price, quantity);
  calc_cart_total();
}

function calc_cart_total() {
  total = 0;
  cost_ajax(cart, (cost) => {
    total += cost;
    shipping_ajax(cart, (shipping) => {
      total += shipping;
      update_total_dom(total);
    });
  });
}
```

=> 문제 상황은 간단해 보인다. 두번의 API 통신이 차례로 이루어지고 있다.
=> 타임라인 다이어그램을 그려 어떤 일이 일어나는지 확인하자

![스크린샷 2024-07-13 오후 1 10 50](https://gist.github.com/user-attachments/assets/45d35248-d251-48da-b99d-216850194bba)

## 두 가지 타임라인 다이어그램 기본 규칙

1. 두 액션이 순서대로 나타나면 같은 타임라인에 넣는다.

2. 두 액션이 동시에 실행되거나 순서를 예상할 수 없다면 분리된 타임라인에 넣는다.

액션이 서로 다른 스레드나 프로세스, 기계, 비동기 콜백에서 실행되면 서로 다른 타임라인에 표시한다. 이 경우는 액션 두 개가 서로 다른 비동기 콜백에서 실행된다.

- 액션은 순서대로 실행되거나 동시에 실행된다.
- 순서대로 실행되는 액션은 같은 타임라인에서 하나가 끝나면 다른 하나가 실행된다.
- 동시에 실행되는 액션은 여러 타임라인에서 나란히 실행된다.

## 액션 순서에 관한 두 가지 사실

1. ++와 +=는 사실 세 단계이다.

total++ 이란 코드는 아래 3가지 순서를 가진다.

```javascript
let temp = total; // 읽기 (액션)
temp = temp + 1; // 더하기(계산)
total = temp; // 쓰기(액션)
```

2. 인자는 함수를 부르기 전에 실행한다.

console.log(total) 이란 코드는 아래 2가지 순서를 가진다.

```javascript
const temp = total; // 읽기(액션)
console.log(temp); // 출력(액션)
```

### add_to_cart 타임라인 그리기: 단계 1

타임라인 다이어그램은 모두 세 단계로 그릴 수 있다.

1. 액션을 확인한다.
2. 순서대로 실행되거나 동시에 실행되는 액션을 그립니다.
3. 플랫폼에 특화된 지식을 사용해 다이어그램을 단순하게 만든다.

계산은 다이어그램을 그릴 때 신경 쓰지 않아도 된다.

![스크린샷 2024-07-13 오후 1 23 13](https://gist.github.com/user-attachments/assets/df4b73b5-7a9e-4b4b-964b-015a8b228df7)

다음으로는 비동기 콜백을 어떻게 그리는지 알아보자.

### 비동기 호출은 새로운 타임라인으로 그린다

사용자와 문서를 저장하는 코드를 통해 알아보자.

```js
saveUserAjax(user, () => setUserLoadingDom(false));
setUserLoadingDom(true);

saveDocumentAjax(doc, () => setDocLoadingDom(false));
setDocLoadingDom(true);
```

![스크린샷 2024-07-13 오후 1 28 20](https://gist.github.com/user-attachments/assets/c2e7c12b-adc2-4c19-839c-2220edc618e0)

### add_to_cart 타임라인 그리기: 단계 2

순서대로 실행되거나 동시에 실행되는 액션을 그린다.

![스크린샷 2024-07-13 오후 1 34 23](https://gist.github.com/user-attachments/assets/3cae58ee-c442-4535-81e7-6d98d89bf7bc)

### 코드는 두 가지 형태로 실행될 수 있다.

자바스크립트 스레드 모델에서 동기화된 액션 사이에는 다른 액션이 끼어들 수 없다.

순서대로 실행되지만 순서가 섞일 수 있는 코드와 그렇지 않은 코드 모두 타임라인 다이어그램으로 표현할 수 있다.

### 동시에 실행되는 코드는 순서를 예측할 수 없다.

동시에 실행되는 코드는 실행 순서를 확신할 수 없다. 동시에 실행되는 코드는 타임라인 다이어그램에 나란히 표현한다.

![스크린샷 2024-07-13 오후 1 56 23](https://gist.github.com/user-attachments/assets/eafe784d-7d17-4381-92da-d4f807f0a9d2)

실행 가능한 순서는 문제가 될 수 있기 때문에 예상할 수 있어야 한다.

박스가 하나 있는 두 개의 타임라인은 세 가지 순서로 실행될 수 있다. 타임라인이 길어지거나 더 많아지면 가능한 실행 순서는 빠르게 늘어난다. 이 점을 명확히하고 넘어가자.

## 좋은 타임라인의 원칙

1. 타임라인은 적을수록 이해하기 쉽다.

타임라인이 하나인 시스템이 가장 이해하기 쉽다. 타임라인이 하나라면 모든 액션은 앞의 액션 다음에 바로 실행된다. 하지만 요즘 시스템에는 여러 타임라인이 필요하다. 멀티스레드나 비동기 콜백, 클라이언트-서버 간 통신 등을 사용하려면 새로운 타임라인이 필요하다.

새로운 타임라인은 항상 시스템을 이해하기 어렵게 만든다. 타임라인 수를 줄여 이해하기 쉬운 시스템을 만들자. but 타임라인 수를 마음대로 조정할 수는 없다.

2. 타임라인은 짧을수록 이해하기 쉽다.

타임라인을 이해하기 쉽게 만드는 또 다른 방법은 타임라인의 단계를 줄이는 것이다.

3. 공유하는 자원이 적을수록 이해하기 쉽다.

서로 다른 타임라인에 있는 두 액션이 서로 자원을 공유하지 않는다면 실행 순서에 신경 쓸 필요가 없다. 실행 가능한 순서의 개수가 줄어들지는 않지만, 신경 써야 할 실행 가능한 순서를 줄일 수 있다.

4. 자원을 공유한다면 서로 조율해야 한다.

공유 자원을 많이 없앤다고 해도 여전히 없앨 수 없는 공유 자원이 남는다. 타임라인은 공유 자원을 안전하게 공유할 수 있어야 한다. 안전하게 공유한다는 말은 올바른 순서대로 자원을 쓰고 돌려준다는 말이다.

5. 시간을 일급으로 다룬다.

액션의 순서와 타이밍을 맞추는 것은 어렵다. 타임라인 다루는 재사용 가능한 객체를 만들면 타이밍 문제를 쉽게 해결할 수 있다.

## 자바스크립트의 단일 스레드

자바스크립트의 스레드 모델은 타임라인이 자원을 공유하면서 생기는 문제를 줄여준다. 자바스크립트는 하나의 메인 스레드만 있어서 대부분의 액션을 하나의 박스로 표현할 수 있다.

그렇기 때문에 액션이 동시에 실행되어 생기는 문제는 없다.

일반적인 절차적 프로그래밍으로 공유변수를 읽고 쓸 때 고려해야 할 것들을 자바스크립트에서는 신경 쓸 필요가 없다.

하지만 비동기 콜백을 함께 사용한다면 문제가 생길 수 있다. 비동기 호출은 미래에 알 수 없는 시점에 런타임에 의해 실행된다. 따라서 박스 사이에 선이 길어질 수도 있고 짧아질 수도 있다. 그렇기에 해당 로직이 비동기인지 아닌지 판단하는 것이 매우 중요하다.

## 자바스크립트의 비동기 큐

브라우저의 경우 작업 큐라고 하는 큐를 가지고 있다. 작업 큐는 이벤트 루프에 의해 처리된다. 이벤트 루프는 큐에서 작업 하나를 꺼내 실행하고 완료되면 다음 작업을 꺼내는 실행을 무한히 반복한다. 이벤트 루프는 하나의 스레드에서 처리하기 때문에 두 개의 작업이 동시에 실행될 수 없다.

### 작업이란?

작업 큐에 있는 작업은 이벤트 데이터와 이벤트를 처리할 콜백으로 구성된다. 이벤트 루프는 이벤트 데이터를 인자로 콜백을 부른다. 콜백은 이벤트 루프가 실행할 함수이다. 입네트 루프는 단순히 첫 번째 인자에 이벤트 데이터를 넣어 콜백 함수를 실행한다.

### 작업은 큐에 어떻게 들어갈까?

이벤트가 발생하면 큐에 작업이 추가 된다. 이벤트는 마우스 클릭이나 키보드 입력, AJAX 이벤트 같은 것을 말한다. 만약 콜백 함수가 있는 버튼에 이벤트가 발생하면 콜백 함수와 이벤트 데이터가 큐에 추가된다. 마우스 클릭처럼 어떤 이벤트도 예상할 수 없기 떄문에 이벤트는 예측 불가능한 시점에 작업 큐에 들어간다.

### 작업이 없을 때 엔진은?

처리할 작업이 없는 경우에는 이벤트 루프가 대기한다. 이벤트 루프는 작업이 추가될 때까지 대기한다. 작업이 추가되면 이벤트 루프는 작업을 꺼내 실행한다.

## AJAX와 이벤트 큐

AJAX는 브라우저에 기반을 둔 웹 요청을 말한다. Asynchronous JavaScript and XML의 약자이다. 실제로 XML을 사용하지 않지만, 용어는 그대로 남아 있다. 일반적으로 브라우저에서 서버와 통신할 때 AJAX를 사용한다.

자바스크립트에서 AJAX 요청을 만들면 네트워크 엔진이 AJAX 요청을 처리하기 위해 요청 큐에 넣는다. 요청 큐에 작업이 추가되어도 코드는 계속 실행된다. 요청이 완료될 떄까지 기다릴 필요가 없다. 많은 언어가 요청이 완료되어야 다음 코드를 진행할 수 이는 동기 요청 방식이지만 자바스크립트에서 AJAX 요청은 비동기 방식으로 처리된다.

### 요청에 대한 응답을 기다리지 않으면 응답을 어떻게 받을까?

AJAX 요청을 만들 때 요청에 관련된 다양한 이벤트 콜백을 등록한다. 콜백은 이벤트가 발생했을 때 실행되는 함수이다.

요청이 처리되는 동안 네트워크 엔진에 의해 다양한 이벤트가 발생한다. 많인 사용되는 이벤트느 load와 error이다. load는 응답이 모두 다운로드 되었을 때 발생하는 이벤트이다. 이 이벤트에 콜백을 등록하면 요청이 완료되었을 때 코드를 실행할 수 있다.

## 타임라인 다이어그램 그리기

1. 액션을 확인한다.
   모든 액션은 타임라인에 표시되어야 한다. 복합적인 액션도 있으므로 변수를 읽고 쓰는 것처럼 하나의 액션처럼 보이지만 여러 액션으로 되어 있는 액션을 하나의 액션으로 파악하기 위해 주의 깊게 봐야 한다.

2. 액션을 그리기
   액션은 순서대로 실행되거나 동시에 실행될 수 있다.

2-1. 순서대로 실행되는 액션

순서대로 실행되는 액션은 같은 타임라인에 표시된다. 함수의 인자가 왼쪽에서 오른쪽으로 평가되는 것처럼 순서대로 실행되는 액션은 문법에 있을 수도 있다.

2-2. 동시에 실행되는 액션

동시에 실행되거나 순서가 섞여서 실행되는 경우 분리된 타임라인으로 표시한다. 다음과 같이 다양한 경우에 액션이 동시에 실행될 수 있다.

- 비동기 콜백
- 멀티 프로세스
- 멀티스레드
- 여러 장치

모든 액션을 그린 후 실행 순서를 제한하기 위해 점선을 사용할 수 있다.

1. 타임라인을 단순화하기

언어의 특징을 사용해서 타임라인을 단순화한다.

- 순서가 섞이지 않는 두 액션은 하나의 박스로 합친다.
- 타임라인 끝에서 새로운 타임라인이 하나만 생긴다면 하나로 합친다.
- 순서에 제약이 있는 경우 점선을 추가한다.

4. 타임라인 읽기
   일반적으로 서로 다른 타임라인에 있는 액션은 세 가지 순서로 실행될 수 있다. 동시에 실행되거나 왼쪽이 먼저 실행되거나 오른쪽이 먼저 실행될 수 있다. 이런 경우 순서는 불가능하거나 기대한대로 이거나 잘못된 결과를 가져올 수 있다.
