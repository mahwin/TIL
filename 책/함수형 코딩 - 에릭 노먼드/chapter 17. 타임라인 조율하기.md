# 타임라인 조율하기

타임라인이 함께 협력해야 하는 경우가 있다. 타임라인을 조율하고 잘못된 실행 순서를 없애기 위한 동시성 기본형을 만들어 보자

## 타임라인을 나누기 위한 동시성 기본형

여러 타임라인이 다른 시간에 종료되어도 서로 기다릴 수 있는 간단하고 재사용 가능한 기본형이 필요하다. 만약 그런 것이 있다면 여러 타임라인이 실행되는 순서를 신경 쓰지 않아도 되고 타임라인이 모두 끝나는 것도 쉽게 처리할 수 있다. 결국 경쟁 조건을 막을 수 있다.

멀티스레드를 지원하는 언어에서는 스레드가 변경 가능한 상태를 공유하기 위해 원자적 업데이트 같은 기능을 사용해야 한다. 하지만 자바스크립트는 단일 스레드라는 장점을 활용할 수 있다. 가능한 동기적으로 접근하는 간단한 변수로 동시성 기본형을 구현할 수 있다.

```js
function Cut(num, callback) {
  let num_finished = 0;
  return function () {
    num_finished++;
    if (num_finished === num) {
      callback();
    }
  };
}
```

`간단한 예제`

```js
const done = Cut(3, function () {
  console.log("3 tasks finished");
});

done();
done();
done();
```

### 코드에 Cut() 적용하기

Cut 동시성을 장바구니에 제품을 추가하는 코드에 적용해 보자. 고려할 대상은 다음과 같다.

1. Cut()을 보관할 범위
2. Cut()에 어떤 콜백을 넣을지

`1. Cut()을 보관할 범위`
응답 콜백 끝에서 done()을 불러야 한다. 따라서 두 응답 콜백을 만드는 calc_cart_total() 함수 내부에 Cut()을 넣어야 한다.

`2. Cut()에 어떤 콜백을 넣을지`
calc_cart_total() 에는 total 값 계산이 끝났을 때 부르는 콜백이 이미 있다. 따라서 cut() 콜백에서 calc_cart_total() 콜백을 실행하자.

![스크린샷 2024-07-14 오후 8 42 28](https://gist.github.com/user-attachments/assets/16eb172d-1c40-4dc5-a3a0-0f5b056716d7)

## 불확실한 순서 분석하기

Cut() 동시성 기본형을 코드에 적용해 봤다. 동시에 실행하기 때문에 빠르고 모든 실행 순서에 문제가 없어서 올바르게 동작하리라 예상된다. 올바른 결과가 나오는지 확인해보자.

자바스크립트 스레드 모델에서 동시에 실행하는 것이 불가능하기 때문에 두 가지 일이 동시에 일어날 순 없다. 그렇기에 A라는 일과 B라는 타임라인 박스가 있다면 A,B B,A 순서로 실행되는 것이다.

## 여러 번 클릭하는 경우 분석

다음은 여러번 클릭했을 경우의 다이어그램이다.

![스크린샷 2024-07-14 오후 8 46 13](https://gist.github.com/user-attachments/assets/8c5ac925-45a3-4327-8d90-7a10d02f10c7)

큐 타임라인에서 병렬로 실행되는 두 ajax 콜백을 나타내기 위해 처음 보는 표현을 사용했다. 실제로 타임라인은 두 개지만 Cut()을 사용했기 때문에 하나로 다시 합쳐진다. 이런 방법은 다이어그램이 유연하다는 것을 보여준다. 세부적인 것이 많은 복잡한 상황을 분석하기 위해 이런 표현을 사용하면 좋다.

## 딱 한 번만 호출하는 기본형

여러 번 호출해도 한 번만 실행되도록 만드는 함수를 만들자.

```js
function JustOnce(action) {
  let already_called = false;
  return function (a, b, c) {
    if (already_called) return;
    already_called = true;
    return action(a, b, c);
  };
}
```

## 암묵적 시간 모델 vs 명시적 시간 모델

모든 언어는 암묵적으로 시간에 대한 모델을 가지고 있다. 시간 모델로 실행에 관한 두 가지 관점을 알 수 있다. 바로 순서와 반복이다.

자바스크립트의 시간 모델은 아래와 같다.

1. 순차적 구문은 순서대로 실행된다.
2. 두 타임라인에 있는 단계는 왼쪽 먼저 실행되거나, 오른쪽 먼서 실행될 수 있다.
3. 비동기 이벤트는 새로운 타임라인에서 실행된다.
4. 액션은 호출할 때마다 실행된다.

간단한 프로그램에서 암묵적 시간 모델은 좋다. 하지만 실행 방식을 바꾸지 못한다. 사실 암묵적 시간 모델의 실행 방식이 애플리케이션에서 필요한 실행 방식과 딱 맞을 일은 거의 없다. 그래서 함수형 개발자는 필요한 실행 방식에 가깝게 새로운 시간 모델을 만든다.

## 요약: 타임라인 사용하기

`타임라인 수를 줄이자.`
스레드나 비동기 호출, 서버 요청을 줄여 적은 타임라인을 만들면 시스템이 단순해진다.

`타임라인 길이를 줄이자.`
타임라인에 있는 액션을 줄여보자. 또 액션을 계산으로 바꿔 보자.

`공유 자원을 없애자.`
자원을 공유하지 않는 타임라인은 순서 문제가 생기지 않는다.

`동시성 기본형으로 자원을 공유하자.`
자원을 안전하지 않게 공유한다면 큐나 락을 사용해 안전하게 공유할 수 있는 방법으로 바꾸자.

`동시성 기본형으로 조율하자`
타임라인을 조율하기 위해 Promise나 컷과 같은 것으로 액션에 순서나 반복을 제한하자.

## 요점 정리

- 함수형 개발자는 언어가 제공하는 암묵적 시간 모델 대신 새로운 시간 모델을 만들어 사용한다.
- 명시적 시간 모델은 종종 일급 값으로 만든다. 일급 값으로 만든 시간 모델은 프로그래밍 언어를 사용해서 시간을 다룰 수 있다.
- 타임라인을 조율하기 위해 동시성 기본형을 만들 수 있다. 가능한 순서를 제한해 항상 올바른 결과가 나올 수 있도록 보장하자
- 타임라인을 나누는 것도 타임라인을 조율하는 방법 중 하나이다.
