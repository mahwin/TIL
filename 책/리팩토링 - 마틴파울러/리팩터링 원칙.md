# 리팩터링 원칙

## 리팩터링 정의

리팩터링은 명사로도, 동사로도 사용할 수 있다.

리팩터링[명사]: 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법.

리팩터링[동사]: 소프트웨어의 겉보기 동작은 그대로 유지한 채, 여러 가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하는 작업.

리팩터링 과정에서 코드가 깨져서 고생했다면 그것은 리팩터링이 아니다. 리팩터링은 동일한 동작을 유지한 채로 코드를 정리하는 작업이다.

그렇다고 완전히 동일한 것은 아니다. 함수로 빼낸다 던지 하는 행위에 따라서 콜스택이 달라지기도 한다.

## 두 개의 모자

프로그래머는 두 개의 모자를 쓴다. 하나는 '기능 추가 모자', 다른 하나는 '리팩터링 모자'이다.

`기능 추가 모자`일 경우 기존 코드는 전혀 건드리지 않는다. 진척도는 새 테스트를 추가하고 통과하는 지로 체크한다.

`리팩터링 모자`일 경우 기능 추가는 절대 하지 않고, 오로지 코드 재구성에만 전념한다.

## 리팩터링하는 이유

리팩토링은 모든 문제점을 해결하지는 않지만, 건강한 소프트웨어를 유지하는 데 도움을 주는 것은 확실한다.

### 리팩터링하면 소프트웨어 설계가 좋아진다.

아키텍처를 충분히 이해하지 못한 채 단기 목표만을 위해 코드를 수정하면 기반 구조가 무너진다. 리팩터링은 코드의 구조를 지탱해줄 것이다.

### 리팩터링하면 소프트웨어를 이해하기 쉬워진다.

프로그래밍은 내가 원하는 바를 정확히 표현하는 것이다. 내 소스코드는 컴퓨터만 읽는 것이 아니다. 개발자(나)도 읽어야 한다.

### 리팩터링하면 버그를 쉽게 찾을 수 있다.

코드를 이해하기 쉽다는 것은 버그를 찾기 쉽다는 것이다.

### 리팩터링하면 프로그래밍 속도를 높일 수 있다.

내부 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 지점과 어떻게 고칠지를 쉽게 찾을 수 있다.

## 언제 리팩터링해야 할까?

> 돈 로버츠가 제시하 3의 법칙
>
> 1. 처음에는 그냥 한다.
> 2. 비슷한 일을 두 번째로 하게 되면, 일단 계속 진행한다.
> 3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.

### 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기

리팩터링하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다. 이 시점에 현재 코드를 살펴보면서, 구조를 살짝 바꾸면 다른 작업을 하기가 쉬워질 만한 부분을 찾는다.

### 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기

코드를 수정하려면 먼저 그 코드가 하는 일을 파악해야 한다. 코드의 구조를 파악할 때마다 그 코드의 의도가 더 명확하게 드러나도록 리팩터링을 진행하자.

### 쓰레기 줍기 리팩터링

비효율적으로 처리되는 로직은 리팩터링을 통해 효율적으로 만들어야 한다. 코드를 읽을 때마다 조금씩 개선하다 보면 결국 문제는 해결될 것이다.

### 계획된 리팩터링과 수시로 하는 리팩터링

리팩터링 시간을 일정에 따로 잡아두지 않고, 대부분의 리팩터링은 다른 일을 하는 중에 처리하자.

그렇다고 계획된 리팩터링이 나쁜 것은 아니다. 리팩터링에 소홀했다면 당연히 시간을 내어 리팩터링을 해야 한다. 웬만하면 기회가 될 때마다 리팩터링을 하자.

### 오래 걸리는 리팩터링

대부분의 리팩터링은 오래 걸리지 않는다. 하지만 팀 전체가 달려들어도 몇 주가 걸리는 대규모 리팩터링도 있다. 라이브러리를 새 것으로 교체하는 작업일 수도 있고, 일부 코드를 다른 팀과 공유하기 위해 컴포넌트로 빼내는 작업일 수도 있다.

그보다는 주어진 문제를 몇 주에 걸쳐 조금씩 해결해가는 편이 효과적을 때가 더 많다.

### 코드 리뷰에 리팩터링 활용하기

코드 리뷰는 개발팀 전체에 지식을 전파하는 데 좋다.

코드 리뷰를 진행하는 과정에서 리팩토링을 수행하는 것은 팀 전체 소프트웨어를 하나의 표준으로 만드는 데 도움이 된다.

일반적인 pull request model 보다는 직접 참석자가 참여하는 짝 프로그래밍이 좋다.

### 관리자에게 뭐라고 말해야 할까?

관리자가 리팩토링에 대해 의구심을 가진다면 리팩터링한다고 말하지 말고 리팩토링을 점진적으로 수행하자.

### 리팩터링하지 말아야 할 때

1. 지저분한 코드를 발견해도 굳이 수정할 필요가 없다면 리팩터링을 하지 않는다.

2. 리팩터링하는 것보다 처음부터 새로 작성하는 게 쉬울 때도 리팩터링하지 않는다.

## 리팩터링 시 고려할 문제

리팩토링이 가져올 문제점에 대해서도 반드시 파악하고 있어야 한다.

### 새 기능 개발 속도 저하

많은 사람들은 리팩토링이 기능 개발 시간을 늦춘다고 생각하지만, 리팩토링의 궁극적인 목적은 개발 속도를 높이는 데 있다.

대부분은 리팩토링을 과도하게 하는 경우보다 거의 하지 않는 경우가 훨씬 많다. 대부분은 리팩터링을 더 자주 하도록 노력해야 한다.

리팩터링을 '클린 코드'나 '바람직한 엔지니어링 습관'처럼 도덕적인 이유로 정당화하는 것은 위험하다. 리팩터링은 오로지 `경제적인 이유`로 하는 것이다.

### 코드 소유권

함수를 호출하는 코드의 소유자가 다른 팀이라면 어떻게 리팩토링 해야할까?

새로운 함수를 만들고 기존 함수 내에서 새로운 함수를 호출하도록 변경한다. 인터페이스는 복잡해지지만 클라이언트에 영향을 주지 않기 위해서는 어쩔 수 없다.

코드 소유권이 작은 단위로 나뉘어 있으면 리팩터링을 적용하기 어렵다. 코드 소유권을 엄격히 제한하는 방식과 완전히 풀어서 변경을 통제하기 어려운 방식을 절충한 것이 대규모 시스템 개발 시에 잘 어울린다.

### 테스팅

리팩터링을 올바르게 수행했는 지 확인하기 위해서는 자가 테스트 코드가 필요하다.

### 레거시 코드

레거시 코드는 대체로 복잡하고 테스트도 제대로 갖춰지지 않은 것이 많다. 그렇기에 레거시 시스템을 파악할 때 리팩터링을 적용하는 것이 큰 도움이 된다.

테스트를 염두에 두고 설계한 시스템만 쉽게 테스트할 수 있기 때문에 레거시 코드의 경우에는 테스트하기 어매우 어렵다.

## 리팩터링, 설계, 아키텍처

예전에는 코딩을 시작하기 전에 소프트웨어 설계와 아키텍처가 어느 정도 완료해야 한다는 관점이 우세했으나 지금은 아키텍처를 대폭 변경할 수 있다고 생각한다.

코딩 전에 아키텍처 구조를 완료할 수 있다는 생각은 요구 사항이 사전에 모두 파악해야 가능한 것이다. 하지만, 요구 사항이 변경되는 일을 매우 빈버낳게 일어난다.

## 리팩터링과 소프트웨어 개발 프로세스

리팩토링의 첫 첫 번째 토대는 자가 테스트 코드다. 팀으로 개발하면서 리팩터링을 하려면 각 팀원이 다른 사람의 작업을 방해하지 않으면서도 언제나 리팩터링 할 수 있어야 한다. 이를 위해서 지속적 통합이 필요하다. 자가 테스트 코드, 지속적 통합, 리팩터링은 서로 연결된 개념이다.

## 리팩터링과 성능

리팩터링하면 소프트웨어가 느려질 수도 있는 건 사실이다. 하지만 그와 동시에 성능을 튜닝하기는 더 쉬워진다.
