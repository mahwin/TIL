### TCP/IP 4계층

네트워크를 이용하여 데이터를 보낸다고 했을 때 생기는 고민들을 각 계층마다 독릭적인 역할을 수행하도록 만든 모델. 데이터를 전송하는데 있어서 효율적으로 데이터를 전송할 수 있도록 도와준다. 이를 기반으로 자주 쓰이는 전송 계층의 TCP와 인터넷 계층의 IP를 묶어 TCP/IP 4계층이라고 한다.

### TCP/IP 4계층 구조

<img width="403" alt="스크린샷 2024-04-17 오후 2 27 22" src="https://gist.github.com/assets/78193416/c456104c-5882-4a47-84d7-3965239ef2ef">

### Application Layer

HTTP, SMTP, SSH, FTP 등의 프로토콜이 존재하며, 사용자와 가장 가까운 계층이다. 사용자의 요청을 받아들이고, 이를 하위 계층으로 전달한다. 실질적으로 서비스를 제공하는 층이다.

### Transport Layer

TCP, UDP가 대표적이며 애플리케이션 계층에서 받은 메시지를 세그먼트(TCP)나 데이터그램(UDP)으로 나누어 인터넷 계층으로 전달한다. 데이터가 오류없이 전달되도록 오류체크를 담당한다.

### Internet Layer

IP, ICMP, ARP 등의 프로토콜이 존재하며, 데이터를 목적지까지 전달하는 역할을 한다. 데이터를 패킷으로 나누어 링크 계층으로 전달한다.

### Link Layer

링크 계층은 전선, 광섬유, 무선 등으로 데이터가 네트워크를 통해 물리적으로 전송되는 방식을 정의한다. 데이터링크계층과 물리계층을 합친 계층이다.

### 캡슐화와 비캡슐화

`캡슐화`란 송신자가 수신자에게 데이터를 보낼 때 데이터가 각 계층을 지나며 각 계층의 특징들이 담긴 헤더들이 붙여지는 과정을 의미한다.</br>
`비캡슐화`는 `캡슐화`의 반대 과정이다. 수신자가 송신자로부터 데이터를 받을 때 각 계층을 지나며 헤더들이 제거되는 과정을 의미한다.

### PDU

PDU란 각 계층의 데이터 단위를 의미한다.

- 애플리케이션 계층 : 메시지
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층 : 패킷
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

### 프레임

MAC 주소 헤더와 CRC/체크섬 트레일러가 붙은 조각

### CRC/체크섬 트레일러

데이터의 오류감지를 위한 수학적 함수가 적용된 값들이 있는 필드.
CRC와 체크섬 두가지의 과정을 기반으로 데이터 전송오류 및 데이터무결성을 방지하게 된다.

### OSI 7계층

<img width="597" alt="스크린샷 2024-04-17 오후 4 13 38" src="https://gist.github.com/assets/78193416/8fcd26dd-3fbb-446c-a98d-9974cd4ba33d">

더 세밀하게 나누는 것이지, 큰 의미는 없다.

### MTU, MSS 란?

#### `MTU(Maximum Transmission Unit)`

한번에 전송할 수 있는 최대 데이터 패킷의 크기. 해당 크기를 기준으로 데이터가 쪼개져서 패킷화된다.

패킷이 분활되지 않는 경우가 발생할 수 있기 때문에 주의해야한다.

- IPv6의 경우 분활 허용 X
- IPv4의 경우 `Don't Fragment(DF)` 플래그를 사용
  - 0 : 분활 허용
  - 1 : 분활 불가

#### `MSS(Maximum Segment Size)`

TCP 세그먼트의 최대 크기를 의미한다. MTU 크기에서 IP 헤더와 TCP 헤더를 제외한 값이다.

<img width="809" alt="스크린샷 2024-04-17 오후 4 19 36" src="https://gist.github.com/assets/78193416/6687958d-a2e9-40ba-bef6-6812a22a5464">

일반적으로 MTU는 1500Bytes, IP 헤더는 20Bytes, TCP 헤더는 20Bytes이므로 MSS는 1460Bytes이다.
TCP를 쓰지 않는 등의 이유로 달라질 수 있음.

### 애플리케이션 계층

HTTP, SMTP, SSH, FTP가 대표적이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층

#### `HTTP`

서버와 브라우저간의 데이터를 주고 받기 위해 설계된 프로토콜. 지금은 서버간의 통신할 때도 이용됨.

#### 특징

- 헤더를 통한 확장이 쉽다.
- stateless하다.

#### `SSH`

Secure Shell의 약자로, 원격지에 있는 컴퓨터에 접속하기 위한 프로토콜. 암호화된 통신을 제공한다.

#### `FTP`

파일 전송 프로토콜로, 파일을 전송하기 위한 프로토콜. 지금은 파일을 암호화해서 보내는 FTPS 또는 SFTP를 사용한다.

#### `SMTP`

Simple Mail Transfer Protocol의 약자로, 이메일을 보내기 위한 프로토콜.

### 전송 계층

TCP, UDP가 대표적이며 애플리케이션에서 받은 메시지를 기반으로 세그먼트 또는 데이터그램으로 데이터를 쪼개고 데이터가 오류없이 순서대로 전달되도록 도움을 주는 계층.

#### `TCP`

가상회선패킷교환방식을 사용해서 순서대로 세그먼트를 보낸다.
오류검사 메커니즘으로 서버는 전달되지 않은 데이터에 대해 재전송을 시도하고, 체크섬을 통해 무결성을 평가한다.

TCP 헤더의 크기는 20 ~ 60 바이트로 가변적이다.

#### `TCP의 연결성립`

TCP의 연결은 3개의 과정을 거쳐 성립된다.

1. 클라이언트가 서버에게 연결을 요청하는 SYN 패킷을 보낸다.
   - 해당 패킷에는 ISN을 포함하고 있다.
2. 서버는 클라이언트에게 연결을 수락한다는 ACK와 SYN 패킷을 보낸다.
   - 해당 패킷에는 서버의 ISN과 클라이언트의 ISN + 1이 포함되어 있다.
3. 클라이언트는 서버에게 ACK 패킷을 보내 연결을 수락한다.
   - 해당 패킷에는 서버의 ISN + 1이 포함되어 있다.

- ISN은 TCP 기반 데이터 통신에서 각각의 새 연결에 할당된 고유한 32비트 시퀀스 번호이다.

#### `3-웨이 핸드쉐이크 과정별 상태`

<img width="622" alt="스크린샷 2024-04-17 오후 4 46 40" src="https://gist.github.com/assets/78193416/43430990-29dc-4c37-84b5-29799ebcf8a9">
해당 과정이 있기에 TCP 연결은 신뢰성이 있다고 말한다.

#### `TCP의 연결해제`

TCP의 연결해제는 4개의 과정을 거쳐 성립된다.

1. 클라이언트가 서버에게 연결을 종료한다는 FIN 패킷을 보낸다.
2. 서버는 클라이언트에게 연결을 종료한다는 ACK 패킷을 보낸다.
3. 서버는 클라이언트에게 연결을 종료한다는 FIN 패킷을 보낸다.
4. 클라이언트는 서버에게 연결을 종료한다는 ACK 패킷을 보낸다.

#### `4-웨이 핸드쉐이크 과정별 상태`

<img width="483" alt="스크린샷 2024-04-17 오후 4 48 33" src="https://gist.github.com/assets/78193416/6a9db8f3-5da7-4a03-9013-c860c1daff0d">

#### `TIME_WAIT`

클라이언트는 서버로부터 FIN을 받고 `TIME_WAIT` 상태가 된 후에 2\*MSL 시간이 지나면 연결이 완전히 종료된다.

- MSL : maximum segment lifetime

지연 패킷 등이 발생했을 때를 대비해서 데이터 무결성을 해결하기 위해 `TIME_WAIT` 상태를 유지한다.
3-웨이 핸드쉐이크를 하기 위해서는 서버와 클라이언트가 `CLOSED` 상태여야 하는데, 서버의 FIN을 받고 바로 `CLOSE`가 되어버리면 서버는 `LAST_ACK` 상태일 경우가 발생한다.

#### `UDP`

데이터그램패킷교환방식을 사용해서 데이터그램을 순서에 상관없이 보낸다. 오류검사는 체크섬만 지원한다.

UDP 헤더의 크기는 8바이트로 고정이다.

<img width="621" alt="스크린샷 2024-04-17 오후 4 36 03" src="https://gist.github.com/assets/78193416/d80280a8-daef-40b3-8e95-dc86cc9e19b4">

- 신뢰성의 3-웨이 핸드쉐이크 유무로 판별
- 패킷의 순서는 패킷교환방식에 의해 결정
- TUD에 맞춰서 부르는게 맞지만, 일반적으로 패킷이라고 부름

### 인터넷 계층

IP, ICMP, ARP가 대표적이며 한 노드에서 다른 노드로 전송 계층에서 받은 데이터를 패킷화해서 전송한다.

#### `ICMP`

노드 사이의 통신을 확인할 때 사용함. 데이터 교환에서 사용되지 않는다.

#### `ARP`

IP 주소를 물리적인 MAC 주소로 매핑하기 위해 사용되는 프로토콜

- MAC 주소 : 네트워크 카드의 고유 주소

브로드캐스팅을 네트워크에 연결된 모든 장치에게 요청을 보냄.
해당 장치는 유니캐스트로 응답을 보냄.
