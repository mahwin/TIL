# ðŸ“¡ Web Socketì´ ë­ì•¼?

ìƒì„±ìž: ì •ìœ ì„
ìƒì„± ì¼ì‹œ: 2023ë…„ 11ì›” 14ì¼ ì˜¤ì „ 11:23

### `ì›¹ ì†Œì¼“ì´ëž€?`

- ë‘ í”„ë¡œê·¸ëž¨ ê°„ì˜ ë©”ì‹œì§€ë¥¼ êµí™˜í•˜ê¸° ìœ„í•œ í†µì‹  ë°©ë²• ì¤‘ í•˜ë‚˜
- í‘œì¤€ í”„ë¡œí† ì½œ ì¤‘ í•˜ë‚˜
  - ê²€ì¦ ê¸°ê´€
    - W3C : ì›”ë“œ ì™€ì´ë“œ ì›¹ì„ ìœ„í•œ í‘œì¤€ì„ ê°œë°œí•˜ê³  ìž¥ë ¤í•˜ëŠ” ì¡°ì§
    - IETF : ì¸í„°ë„·ì˜ ìš´ì˜, ê´€ë¦¬, ê°œë°œì— ëŒ€í•´ í˜‘ì˜í•˜ê³  í”„ë¡œí† ì½œê³¼ êµ¬ì¡°ì ì¸ ì‚¬ì•ˆë“¤ì„ ë¶„ì„í•˜ëŠ” ì¸í„°ë„· í‘œì¤€í™” ìž‘ì—… ê¸°êµ¬
- í˜„ìž¬ ì¸í„°ë„· í™˜ê²½ì—ì„œ ë§Žì´ ì‚¬ìš© ë˜ëŠ” í”„ë¡œí† ì½œì´ë‹¤
  - ì•½ 98 % ìœ ì €ì˜ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©ê°€ëŠ¥.
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-11-14 á„‹á…©á„’á…® 1 25 40](https://user-images.githubusercontent.com/78193416/282807455-17dde33f-fb63-413e-a354-38fb22c7289a.png)

### `ì›¹ ì†Œì¼“ì˜ íŠ¹ì§•`

- ì–‘ë°©í–¥ í†µì‹ 
  - ì—°ê²°ëœ ìƒíƒœë¼ë©´ clientì™€ serverê°€ ì›í•  ë•Œ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ì„ ìˆ˜ ìžˆë‹¤.
- ì‹¤ì‹œê°„ ë„¤íŠ¸ì›Œí‚¹
  - ì›¹ í™˜ê²½ì—ì„œ ì—°ì†ëœ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ë…¸ì¶œ
    - ex) ì£¼ì‹ ì°¨íŠ¸, ì±„íŒ…, ë¹„ë””ì˜¤ ë°ì´í„°

### `ì›¹ ì†Œì¼“ ì´ì „ì— ì‚¬ìš©í–ˆë˜ ê¸°ìˆ `

- ì–‘ë°©í–¥ í†µì‹ ì´ë©° ì‹¤ì‹œê°„ ë„¤íŠ¸ì›Œí‚¹ì´ ê°€ëŠ¥í•´ì•¼ í•¨.
- ì¢…ë¥˜
  - Polling
    - ì„œë²„ë¡œ ì¼ì • ì£¼ê¸°ë§ˆë‹¤ ìš”ì²­ì„ ìˆ˜ì‹ 
    - ì¼ì • ì£¼ê¸°ë§ˆë‹¤ ìš”ì²­í•˜ê¸° ë•Œë¬¸ì— ì‹¤ì‹œê°„ê³¼ëŠ” ì°¨ì´ê°€ ìžˆìŒ.
    - ë¶ˆí•„ìš”í•œ requestì™€ connectionì„ ìƒì„±
      - ë°”ë€ ë°ì´í„°ê°€ ì—†ì–´ë„ requestë¥¼ ë‚ ë¦¬ê²Œ ë¨.
  - Long Polling
    - Pollingì˜ ë‹¨ì ì„ ë³´ì™„í•˜ê¸° ìœ„í•´ responseë¥¼ ë°”ë¡œ ë³´ë‚´ì§€ ì•Šê³  eventê°€ ë°œìƒí–ˆì„ ë•Œ responseë¥¼ ë³´ë‚´ëŠ” ë°©ì‹
    - ì´ë²¤íŠ¸ ë°œìƒ í›„ í´ë¼ì´ì–¸íŠ¸ëŠ” ë‹¤ì‹œ requestë¥¼ ë³´ëƒ„
    - ì´ë²¤íŠ¸ê°€ ìƒê¸¸ ë•Œê¹Œì§€ ì—°ê²°ì´ ìœ ì§€ë¨
    - ë§Žì€ ì–‘ì˜ eventê°€ ë°œìƒí•œë‹¤ë©´ pollingê³¼ ì •í™•í•˜ê²Œ ê°™ìŒ
  - Streaming
    - ì„œë²„ì— ìš”ì²­ ë³´ë‚´ê³  ëŠê¸°ì§€ ì•Šì€ ì—°ê²°ìƒíƒœì—ì„œ ëŠìž„ì—†ì´ ë°ì´í„° ìˆ˜ì‹ 
    - í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ë°ì´í„° ì†¡ì‹ ì´ ì–´ë µë‹¤
    - ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-11-14 á„‹á…©á„’á…® 1 36 37](https://user-images.githubusercontent.com/78193416/282807439-83622aae-17f4-4d95-8c6a-947054dfcbcc.png)
- ë‹¨ì 
  - HTTPë¥¼ í†µí•´ í†µì‹ í•˜ê¸° ë•Œë¬¸ì— Headerê°€ ë¶ˆí•„ìš”í•˜ê²Œ í¼

### `ì›¹ ì†Œì¼“ì˜ ë™ìž‘ ë°©ë²•`

- http or https í”„ë¡œí† ì½œì„ ì´ìš©í•´ì„œ í•¸ë“œ ì‰ì´í‚¹í•¨
  - í—¨ë“œ ì‰ì´í‚¹ ê³¼ì •
  - ì²« ì›¹ì†Œì¼“ ì—°ê²°ì„ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ëŠ” request HTTP header
  ```
  GET /chat HTTP/1.1          => ë°˜ë“œì‹œ GET ë©”ì„œë“œ, HTTP ë²„ì „ì€ 1.1 ì´ìƒ
  Host: algo-with-me-api.shop => ì›¹ ì„œë²„ì˜ ì£¼ì†Œ
  Upgrade: websocket          => í˜„ìž¬ í´ë¼ì´ì–¸íŠ¸, ì„œë²„, ì „ì†¡ í”„ë¡œí† ì½œ ì—°ê²°ì—ì„œ ë‹¤ë¥¸ í”„ë¡œí† ì½œë¡œ
  														   ì—…ê·¸ë ˆì´ë“œí•˜ê¸° ìœ„í•œ ê·œì¹™
  Connection: Upgrade         => Upgrade í—¤ë” í•„ë“œê°€ ëª…ì‹œë˜ì—ˆì„ ê²½ìš°,
  															 Connection í—¤ë” í•„ë“œë„ ì „ì†¡
  Sec-WebSocket-Key:          => í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì˜ ì„œë¡œì˜ ì‹ ì›ì„ ì¸ì¦í•˜ëŠ” ë°ì— ì‚¬ìš©
  dG1mdGwdnaiw1dZQj==						 ê¸¸ì´ê°€ 16ë°”ì´íŠ¸ì¸ ìž„ì˜ë¡œ ì„ íƒëœ ìˆ«ìžë¥¼ base64ë¡œ ì¸ì½”ë”© í•œ ê°’
  Origin: í´ë¼ì´ì–¸íŠ¸ì£¼ì†Œ          => ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í•„ìˆ˜í•­ëª©, í´ë¼ì´ì–¸íŠ¸ì˜ ì£¼ì†Œ
  Sec-WebSocket-Protocol      => í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•˜ëŠ” ì—¬ëŸ¬ ì„œë¸Œí”„ë¡œí† ì½œì„ ì˜ë¯¸
  : chat, superchat              ê³µë°±ë¬¸ìžë¡œ êµ¬ë¶„ë˜ë©° ìˆœì„œì— ë”°ë¼ ìš´ì„ ê¶Œ ë¶€ì—¬
                                 ì„œë²„ì—ì„œ ì—¬ëŸ¬ í”„ë¡œí† ì½œ í˜¹ì€ í”„ë¡œí† ì½œ ë²„ì „ì„ ë‚˜ëˆ ì„œ ì„œë¹„ìŠ¤í•  ê²½ìš°
  															 ì´ëŸ¬í•œ ì„œë¸Œ í”„ë¡œí† ì½œì„ ì„œë²„ë¡œ ë³´ë‚´ë©´ ì„œë²„ëŠ” ìžì‹ ì´ ì§€ì›í•˜ëŠ”
  															 ì„œë¸Œ í”„ë¡œí† ì½œì„ ë‹¤ì‹œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜í•¨.
  Sec-WebSocket-Version : 13  => ì›¹ì†Œì¼“ ë²„ì „
  ```
  - ì²« ì›¹ì†Œì¼“ ì—°ê²°ì„ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ì˜ requestì— ëŒ€í•œ ì„œë²„ì˜ response HTTP header
  ```
  HTTP/1.1 101 Switching Protocols => Switching Protocolsì´ ì˜¤ë©´ ì›¹ì†Œì¼“ì´ ì—°ê²° ëë‹¤ëŠ” ì˜ë¯¸
  Upgrade: websocket
  connection: Upgrade
  Sec-WebSocket-Accept             => í´ë¼ì´ì–¸íŠ¸ë¡œ ë°›ì€ Sec-WebSocket-Keyë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°ëœ
  :s3pPLMBiTxaQ9kQkoQadAQDmadQW=      ê°’ìœ¼ë¡œ ì„œë¡œì˜ ì‹ ì›ì„ í™•ì¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.
  ```
  - í•¸ë“œ ì‰ì´í¬ ì™„ë£Œ í›„ ë°ì´í„° ì „ì†¡
    - wsë¼ëŠ” í”„ë¡œí† ì½œë¡œ ë³€ê²½ë¨
      - ws : 80 ë²ˆ í¬íŠ¸, wss : 443 í¬íŠ¸
    - ì£¼ì†Œ ë°›ëŠ” ë°ì´í„°ì˜ ë‹¨ìœ„ëŠ” Messageë¼ê³  í•¨
      - ì—¬ëŸ¬ frameì´ ëª¨ì—¬ì„œ êµ¬ì„±í•˜ëŠ” í•˜ë‚˜ì˜ ë…¼ë¦¬ì  ë©”ì„¸ì§€ ë‹¨ìœ„
        - frameëž€ ?
          - communicationì—ì„œ ê°€ìž¥ ìž‘ì€ ë‹¨ìœ„ì˜ ë°ì´í„°, ìž‘ì€ í—¤ë” + payload
            ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-11-14 á„‹á…©á„’á…® 2 48 32](https://user-images.githubusercontent.com/78193416/282807677-07890cad-0fa1-48ca-b5d5-29efb5573001.png)
            - ENDëŠ” ì „ì²´ ë©”ì‹œì§€ ì¤‘ì— ì´ í”„ë ˆìž„ì´ ë§ˆì§€ë§‰ì¸ê°€ë¥¼ ì•Œë ¤ì£¼ëŠ” flag
            - Opcodeì´ ë©”ì‹œì§€ê°€ ì–´ë–»ê²Œ ì‚¬ìš©ë ì§€ë¥¼ ì•Œë ¤ì¤Œ
              - 0x0 Coutinue : ì „ì²´ ë©”ì‹œì§€ì˜ ì¼ë¶€
              - 0x1 Text : í¬í•¨ëœ ë°ì´í„°ê°€ UTF-8 í…ìŠ¤íŠ¸ë¼ëŠ” ì˜ë¯¸
              - 0x2 Binary : í¬í•¨ëœ ë°ì´í„°ê°€ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¼ëŠ” ì˜ë¯¸
              - 0x8 Close : Close í•¸ë“œ ì‰ì´í¬ë¥¼ ì‹œìž‘í•œë‹¤ëŠ” ì˜ë¯¸
            - Length
              - ì´ í”„ë ˆìž„ì— í¬í•¨ëœ ë°ì´í„°ì˜ ì´ ê¸¸ì´
      - ì›¹ì†Œì¼“ í†µì‹ ì— ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ëŠ” UTF-8 ì¸ì½”ë”©ì„ ì‚¬ìš©
        ex) 0x00 [ë³´ë‚´ê³  ì‹¶ì€ ë°ì´í„°] 0xff ì´ëŸ° ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ê²Œ ë¨.

### `ì›¹ ì†Œì¼“ í”„ë¡œí† ì½œ íŠ¹ì§•`

- ìµœì´ˆ ì ‘ì†ì—ì„œë§Œ HTTP í”„ë¡œí† ì½œ ìœ„ì—ì„œ handshaking í•¨
  - HTTP header
- ì›¹ì†Œì¼“ì„ ìœ„í•œ ë³„ë„ì˜ í¬íŠ¸ëŠ” ì—†ìœ¼ë©´ 80, 443ì„ ì´ìš©í•œë‹¤.
- í”„ë ˆìž„ìœ¼ë¡œ êµ¬ì„±ëœ ë©”ì‹œì§€ë¼ëŠ” ë…¼ë¦¬ì  ë‹¨ìœ„ë¡œ ì†¡ìˆ˜ì‹ í•œë‹¤.
- ë©”ì‹œì§€ì— í¬í•¨ë  ìˆ˜ ìžˆëŠ” êµí™˜ ê°€ëŠ¥í•œ ë©”ì‹œì§€ëŠ” í…ìŠ¤íŠ¸ì™€ ë°”ì´ë„ˆë¦¬ ë¿ì´ë‹¤

### `ì›¹ ì†Œì¼“ì˜ í•œê³„`

- HTML 5 ì´ì „ì˜ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ëŠ” ìœ ì €ì— ëŒ€í•´ì„œëŠ” ??
  - [Socket.io](http://Socket.io) , SockJsë¥¼ ì‚¬ìš©í•œë‹¤
  - HTML5 ì´ì „ì˜ ê¸°ìˆ ë¡œ êµ¬í˜„ëœ ì„œë¹„ìŠ¤ì—ì„œ ì›¹ ì†Œì¼“ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ë„ì™€ì£¼ëŠ” ê¸°ìˆ 
  - ë¸Œë¼ìš°ì €ì™€ ì›¹ ì„œë²„ì˜ ì¢…ë¥˜ì™€ ë²„ì „ì„ íŒŒì•…í•˜ì—¬ ê°€ìž¥ ì í•©í•œ ê¸°ìˆ ì„ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
  - WebSocketì€ ë¬¸ìžì—´ë“¤ì„ ì£¼ê³  ë°›ì„ ìˆ˜ ìžˆê²Œ í•´ì¤„ ë¿ ê·¸ ì´ìƒì˜ ì¼ XXX
    - ì£¼ê³  ë°›ì€ ë¬¸ìžì—´ì— ë”°ë¼ ì–´ë–»ê²Œ í–‰ë™í•  ì§€ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ì±…ìž„!
  - WebSocketì€ í˜•ì‹ì´ ì •í•´ì ¸ ìžˆì§€ ì•Šê¸° ë•Œë¬¸ì— ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•´ì„í•˜ê¸° ì–´ë µë‹¤
    - ê·¸ëž˜ì„œ sub-protocolsë¥¼ ì‚¬ìš©í•´ì„œ ì£¼ê³  ë°›ì„ ë°ì´í„° ë©”ì‹œì§€ì˜ í˜•íƒœë¥¼ ì•½ì†í•œë‹¤.
    - ìžì£¼ ì‚¬ìš©ë˜ëŠ” sub-protocols
      - STOMP (Simple Text Oriented Message Protocol)
        - ì±„íŒ… í†µì‹ ì„ í•˜ê¸° ìœ„í•œ í˜•ì‹ì„ ì •ì˜
        - HTTPì™€ ìœ ì‚¬í•˜ê²Œ ê°„ë‹¨ížˆ ì •ì˜ë˜ì–´ í•´ì„í•˜ê¸° íŽ¸í•œ í”„ë¡œí† ì½œ
        - ì¼ë°˜ì ìœ¼ë¡œ ì›¹ì†Œì¼“ ìœ„í•´ì„œ ì‚¬ìš©
        - í”„ë ˆìž„ êµ¬ì¡°

### ê°„ë‹¨ížˆ êµ¬í˜„í•´ë³´ìž

```jsx
// ì†Œì¼“ ê°ì²´ë¥¼ ë§Œë“¤ê³ , ì›¹ì„œë²„ ì—°ê²°í•˜ê¸°
// ìµœì´ˆì˜ handshakeê°€ ì¼ì–´ë‚¨
// handshakeëŠ” http í†µì‹ ìž„.
const socket = new WebSocket("ws://localhost:3000");

socket.addEventListener("open", (event) => {
  console.log("Connected to WebSocket server");
});

socket.addEventListener("message", ({ data }) => {
  // íŒŒì‹±ì˜ ì£¼ì²´ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜
  // í•¸ë“œì‰ì´í¬ ì´í›„ í†µì‹ ì€ ws í”„ë¡œí† ì½œìž„.
  const { id } = JSON.parse(data);
  const li = document.getElementById(id);
  li.innerHTML = Math.random() > 0.8 ? XSvg : OSvg;
});

function sendMessage() {
  setComponentLoading();
  socket.send("api call");
}

function setComponentLoading() {
  const messageInput = document.getElementById("message_input");

  const lis = document.querySelectorAll("li");
  [...lis].forEach(
    (li) => (li.innerHTML = `<div width='10px'>${loadingSvg}</div>`)
  );
}
```

<video src='../images/ì›¹ì†Œì¼“/01.Web Socketì´ëž€.mov'>

### ì°¸ê³ ë¬¸í—Œ

[https://www.youtube.com/watch?v=MPQHvwPxDUw](https://www.youtube.com/watch?v=MPQHvwPxDUw)
